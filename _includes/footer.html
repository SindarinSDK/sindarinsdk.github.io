<script>
// Sidebar toggle for mobile
document.getElementById('sidebar-toggle').addEventListener('click', function() {
  document.getElementById('sidebar').classList.toggle('open');
  this.classList.toggle('active');
});

// Close sidebar when clicking a link on mobile
document.querySelectorAll('.nav-link, .nav-sublink').forEach(function(link) {
  link.addEventListener('click', function() {
    if (window.innerWidth <= 768) {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebar-toggle').classList.remove('active');
    }
  });
});

// Sindarin syntax highlighting
(function() {
  var kwSet = {fn:1,var:1,if:1,else:1,while:1,for:1,in:1,return:1,import:1,native:1,struct:1,match:1,private:1,shared:1,print:1,println:1,true:1,false:1,as:1,ref:1,val:1,sync:1,lock:1,spawn:1,use:1,packed:1,break:1,continue:1,each:1,sizeof:1,new:1,from:1,to:1,step:1,type:1,opaque:1,enum:1};
  var typeSet = {int:1,str:1,double:1,bool:1,byte:1,char:1,long:1,float:1,uint:1,int32:1,uint32:1,void:1};
  var builtinSet = {TextFile:1,BinaryFile:1,Path:1,Directory:1,Bytes:1,Date:1,Time:1,Process:1,Environment:1,Random:1,UUID:1,TcpStream:1,TcpListener:1,UdpSocket:1,Crypto:1,JSON:1,XML:1,YAML:1,ZLib:1,Stdio:1,Math:1};
  var TOKEN = /\b([a-zA-Z_]\w*(?:\[\])?)\b|\b(\d+\.?\d*)\b|(=&gt;)/g;

  function esc(s) {
    return s.replace(/&/g, '&amp;').replace(/\x3c/g, '&lt;').replace(/>/g, '&gt;');
  }

  function highlightCode(s) {
    s = esc(s);
    return s.replace(TOKEN, function(m, word, num, arrow) {
      if (arrow) return '<span class="sn-operator">=&gt;<\/span>';
      if (num) return '<span class="sn-number">' + num + '<\/span>';
      if (word) {
        var base = word.replace('[]', '');
        var suffix = word.indexOf('[]') >= 0 ? '[]' : '';
        if (builtinSet[base]) return '<span class="sn-type">' + word + '<\/span>';
        if (typeSet[base]) return '<span class="sn-type">' + word + '<\/span>';
        if (kwSet[word]) return '<span class="sn-keyword">' + word + '<\/span>';
      }
      return m;
    });
  }

  var blocks = document.querySelectorAll('code.language-sindarin');
  blocks.forEach(function(block) {
    var lines = block.textContent.split('\n');
    var result = [];
    for (var i = 0; i < lines.length; i++) {
      var line = lines[i];
      // Pragma/comment lines starting with #
      if (/^\s*#/.test(line)) {
        result.push('<span class="sn-keyword">' + esc(line) + '<\/span>');
        continue;
      }
      // Split line at // comment (not inside a string)
      var inStr = false, commentIdx = -1;
      for (var j = 0; j < line.length; j++) {
        if (line[j] === '"' && (j === 0 || line[j-1] !== '\\')) inStr = !inStr;
        if (!inStr && line[j] === '/' && line[j+1] === '/') { commentIdx = j; break; }
      }
      var code = commentIdx >= 0 ? line.slice(0, commentIdx) : line;
      var comment = commentIdx >= 0 ? line.slice(commentIdx) : '';
      // Split code at string literals and highlight non-string parts
      var parts = code.split(/(\$?"[^"]*")/g);
      var highlighted = '';
      for (var k = 0; k < parts.length; k++) {
        var p = parts[k];
        if (p && (p[0] === '"' || (p[0] === '$' && p[1] === '"'))) {
          highlighted += '<span class="sn-string">' + esc(p) + '<\/span>';
        } else {
          highlighted += highlightCode(p);
        }
      }
      if (comment) {
        highlighted += '<span class="sn-comment">' + esc(comment) + '<\/span>';
      }
      result.push(highlighted);
    }
    block.innerHTML = result.join('\n');
  });
})();
</script>
